{{template "partials/header" .}}
{{template "partials/modal" .}}
<div class="items-start md:items-center p-4">
   <div class="flex *:lex-col sm:flex-row items-stretch sm:items-center gap-4 w-full sm:w-auto">
      <input
         id="flag-input"
         class="input max-w-60"
         rows="3"
         placeholder="Enter the flag"
         ></input>
      <button
         id="submit-flag-btn"
         class="h-10 px-5 bg-primary text-white font-medium rounded-lg shadow hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary transition"
         onclick="SubmitFlag()"
         >
      Submit
      </button>
      <p id="flag-submission-status" class="text-sm mt-2 ml-2 text-gray-600 dark:text-neutral-400 self-center">
         <!-- Status -->
      </p>
   </div>
</div>
<div class="flex flex-col">
   <div class="-m-1.5 overflow-x-auto">
      <div class="p-1.5 min-w-full inline-block align-middle">
         <div class="flex flex-col max-h-[80vh] border border-gray-200 dark:border-neutral-700 rounded-lg">
            <div class="overflow-y-auto flex-1">
               <table class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700 relative">
                  <thead class="bg-gray-50 dark:bg-neutral-700 sticky top-0 ">
                     <tr>
                        <th class="th">ID</th>
                        <th class="th">Flag</th>
                        <th class="th">Service</th>
                        <th class="th">Status</th>
                        <th class="th">Submit Time</th>
                        <th class="th">Response Time</th>
                     </tr>
                  </thead>
                  <tbody
                     class="divide-y divide-gray-200 dark:divide-neutral-700"
                     id="flag-table-body"
                     hx-get="/flags/{{.Limit}}?offset=0"
                     hx-trigger="load"
                     hx-target="this"
                     hx-swap="innerHTML"
                     hx-indicator="#spinner"
                     >
                     <!-- HTMX will load rows here -->
                  </tbody>
               </table>
            </div>
            <!-- Spinner -->
            <div id="spinner" class="text-center mt-2 text-gray-500 hidden">
               <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-primary inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
               </svg>
               Loading...
            </div>
            <!-- Pagination -->
            <div id="pagination" class="px-4 py-2 bg-white dark:bg-neutral-700 border-t border-gray-200 dark:border-neutral-700"
               hx-get="/pagination/{{.Limit}}?offset=0"
               hx-trigger="load, flagsUpdated from:body"
               hx-target="this"
               hx-swap="innerHTML">
            </div>
         </div>
      </div>
   </div>
</div>

<script type="module" defer>
   import { uuidv4, sendFlag} from '/js/output.min.js';

   function submitFlag() {
       const flagInput = document.getElementById('flag-input');
       const statusEl = document.getElementById('flag-submission-status');
       const code = flagInput.value.trim();

       if (!code) {
         statusEl.textContent = 'Please enter a flag';
         return;
       }

       const flag = {
         id: uuidv4(),
         flag_code: code,
         service_name: 'unknown',
         service_port: 0,
         team_id: 0,
         status: 'UNSUBMITTED',
         submit_time: Date.now(),
         response_time: 0,
       };

       statusEl.textContent = 'Submittingâ€¦';
       sendFlag(flag)
         .then(res => {
           if (!res.ok) throw new Error('Submission failed');
           return res.json();
         })
         .then(() => {
           flagInput.value = '';
           statusEl.textContent = 'Flag submitted successfully!';
           htmx.trigger(document.body, 'flagsUpdated');
         })
         .catch(err => {
           console.error(err);
           statusEl.textContent = 'Error during submission';
           statusEl.classList.add('text-red-500');
         });
     }


       window.SubmitFlag = submitFlag;

       document.addEventListener("DOMContentLoaded", () => {
         const limit = {{.Limit}};
         const storageKey = "flags-offset";
         let currentPage = 0;

         const storedOffset = parseInt(localStorage.getItem(storageKey), 10);
         if (!isNaN(storedOffset) && storedOffset >= 0) {
           currentPage = Math.floor(storedOffset / limit);
         }

         function updateComponents(newPage) {
           currentPage = newPage;
           const offset = currentPage * limit;

           localStorage.setItem(storageKey, offset);

           htmx.ajax('GET', `/flags/${limit}?offset=${offset}`, {
             target: '#flag-table-body',
             swap: 'innerHTML',
             indicator: '#spinner'
           });

           htmx.ajax('GET', `/pagination/${limit}?offset=${offset}`, {
             target: '#pagination',
             swap: 'innerHTML'
           });
         }


         updateComponents(currentPage);


         document.body.addEventListener('click', function(e) {
           const tgt = e.target.closest('[data-page]');
           if (tgt) {
             e.preventDefault();
             const pg = parseInt(tgt.dataset.page, 10);
             if (!isNaN(pg)) updateComponents(pg);
           }
         });
       });
</script>
