package exploit

import (
	"github.com/ByteTheCookies/CookieFarm/internal/client/api"
	"github.com/ByteTheCookies/CookieFarm/pkg/logger"
	"github.com/ByteTheCookies/CookieFarm/pkg/models"
)

func SubmitFlags(flagsChan <-chan models.ClientData) {
	logger.Log.Info().Msg("Starting submission loop to the cookiefarm server with direct submitter (http)")
	buffer := make([]models.ClientData, 0, 50)
	for flag := range flagsChan {
		buffer = append(buffer, flag)
		if len(buffer) >= 100 {
			if _, err := api.SubmitBatchDirect(buffer); err != nil {
				logger.Log.Error().Err(err).Msg("Error submitting batch of flags")
			} else {
				logger.Log.Info().Msg("Batch of flags submitted successfully")
			}
			buffer = buffer[:0] // Reset the buffer
		}
	}
}

func SubmitFlag(flag models.ClientData) (string, error) {
	if _, err := api.SubmitDirect(flag); err != nil {
		logger.Log.Error().Err(err).Msg("Error submitting flag")
		return "", err
	} else {
		return "Flag submitted successfully", nil
	}
}
